<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>为scikit-learn框架下的流预测加速 | boleml</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="Everything you need to build AI .">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/assets/css/0.styles.afe6f3d6.css" as="style"><link rel="preload" href="/assets/js/app.5f51664a.js" as="script"><link rel="preload" href="/assets/js/3.95a7dbf5.js" as="script"><link rel="preload" href="/assets/js/1.f34e988a.js" as="script"><link rel="preload" href="/assets/js/14.e8bd3478.js" as="script"><link rel="prefetch" href="/assets/js/10.ede0b623.js"><link rel="prefetch" href="/assets/js/11.ef085ea5.js"><link rel="prefetch" href="/assets/js/12.73ed65be.js"><link rel="prefetch" href="/assets/js/13.118974db.js"><link rel="prefetch" href="/assets/js/15.26adc150.js"><link rel="prefetch" href="/assets/js/16.401942cb.js"><link rel="prefetch" href="/assets/js/17.42bb08aa.js"><link rel="prefetch" href="/assets/js/18.72b25c85.js"><link rel="prefetch" href="/assets/js/19.2016707b.js"><link rel="prefetch" href="/assets/js/4.3eeea9ad.js"><link rel="prefetch" href="/assets/js/5.75d5d73e.js"><link rel="prefetch" href="/assets/js/6.b535001c.js"><link rel="prefetch" href="/assets/js/7.875b1da5.js"><link rel="prefetch" href="/assets/js/8.2eb807ba.js"><link rel="prefetch" href="/assets/js/9.b4d019e1.js">
    <link rel="stylesheet" href="/assets/css/0.styles.afe6f3d6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-5bb33761><div data-v-5bb33761><div class="password-shadow password-wrapper-out" style="display:none;" data-v-59e6cb88 data-v-5bb33761 data-v-5bb33761><h3 class="title" data-v-59e6cb88>boleml</h3> <p class="description" data-v-59e6cb88>Everything you need to build AI .</p> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>Leepand</span>
          
        <!---->
        2022
      </a></span></div></div> <div class="hide" data-v-5bb33761><header class="navbar" data-v-5bb33761><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.png" alt="boleml" class="logo"> <span class="site-name">boleml</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/推荐系统/" class="nav-link"><i class="undefined"></i>
  推荐系统
</a></li><li class="dropdown-item"><!----> <a href="/categories/在线学习/" class="nav-link"><i class="undefined"></i>
  在线学习
</a></li><li class="dropdown-item"><!----> <a href="/categories/机器学习实践/" class="nav-link"><i class="undefined"></i>
  机器学习实践
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  更新动态
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Docs
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/mlopskit/" class="nav-link"><i class="undefined"></i>
  mlopskit
</a></li><li class="dropdown-item"><!----> <a href="/docs/banditrl/" class="nav-link"><i class="undefined"></i>
  banditrl
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Contact
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-5bb33761></div> <aside class="sidebar" data-v-5bb33761><div class="personal-info-wrapper" data-v-1fad0c41 data-v-5bb33761><img src="/avatar.png" alt="author-avatar" class="personal-img" data-v-1fad0c41> <h3 class="name" data-v-1fad0c41>
    Leepand
  </h3> <div class="num" data-v-1fad0c41><div data-v-1fad0c41><h3 data-v-1fad0c41>9</h3> <h6 data-v-1fad0c41>Articles</h6></div> <div data-v-1fad0c41><h3 data-v-1fad0c41>6</h3> <h6 data-v-1fad0c41>Tags</h6></div></div> <ul class="social-links" data-v-1fad0c41></ul> <hr data-v-1fad0c41></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/推荐系统/" class="nav-link"><i class="undefined"></i>
  推荐系统
</a></li><li class="dropdown-item"><!----> <a href="/categories/在线学习/" class="nav-link"><i class="undefined"></i>
  在线学习
</a></li><li class="dropdown-item"><!----> <a href="/categories/机器学习实践/" class="nav-link"><i class="undefined"></i>
  机器学习实践
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  更新动态
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Docs
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/mlopskit/" class="nav-link"><i class="undefined"></i>
  mlopskit
</a></li><li class="dropdown-item"><!----> <a href="/docs/banditrl/" class="nav-link"><i class="undefined"></i>
  banditrl
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Contact
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav> <!----> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-59e6cb88 data-v-5bb33761><h3 class="title" data-v-59e6cb88>为scikit-learn框架下的流预测加速</h3> <!----> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>Leepand</span>
          
        <!---->
        2022
      </a></span></div></div> <div data-v-5bb33761><div data-v-5bb33761><main class="page"><section style="display:;"><div class="page-title"><h1 class="title">为scikit-learn框架下的流预测加速</h1> <div data-v-8a445198><i class="iconfont reco-account" data-v-8a445198><span data-v-8a445198>Leepand</span></i> <i class="iconfont reco-date" data-v-8a445198><span data-v-8a445198>9/10/2022</span></i> <!----> <i class="tags iconfont reco-tag" data-v-8a445198><span class="tag-item" data-v-8a445198>machine learning</span><span class="tag-item" data-v-8a445198>online learning</span><span class="tag-item" data-v-8a445198>MLOps</span></i></div></div> <div class="theme-reco-content content__default"><h1 id="目录"><a href="#目录" class="header-anchor">#</a> 目录</h1> <ul><li><a href="#%E6%A6%82%E8%BF%B0">概述</a></li> <li><a href="#%E6%93%8D%E4%BD%9C%E7%A4%BA%E4%BE%8B">操作示例</a></li> <li><a href="#%E6%80%BB%E7%BB%93">总结</a></li></ul> <h2 id="概述"><a href="#概述" class="header-anchor">#</a> 概述</h2> <p>在机器学习的实际应用场景中常见的做法是，在把机器学习模型封装为API路由提供预测服务之前，先进行离线训练。具体来说，我们希望有一个API路由可以对单一行/实例/样本/数据点/事件（随你怎么叫）进行预测。市面上我们有很好的工具来做这件事，这些工具可以帮助处理到琐碎的细节，比如<a href="https://github.com/cortexlabs/cortex" target="_blank" rel="noopener noreferrer">Cortex<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、<a href="https://www.mlflow.org/docs/latest/models.html" target="_blank" rel="noopener noreferrer">MLFlow<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、<a href="https://www.kubeflow.org/docs/components/serving/" target="_blank" rel="noopener noreferrer">Kubeflow<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>和<a href="https://github.com/ucbrise/clipper" target="_blank" rel="noopener noreferrer">Clipper<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。还有一些商业版的服务，如<a href="https://www.datarobot.com/" target="_blank" rel="noopener noreferrer">DataRobot<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、<a href="https://www.h2o.ai/" target="_blank" rel="noopener noreferrer">H2O<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>和<a href="https://www.cubonacci.com/" target="_blank" rel="noopener noreferrer">Cubonacci<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>这些解决方案通常假定你将使用数据科学生态系统中的一个流行库，如scikit-learn、Keras、PyTorch、XGBoost或LightGBM。需要注意的是，这些库中的大多数从来都不是为了进行预测而设计的。事实上，它们中的很大一部分是在把机器学习模型放在API端点后面变得很酷（真正的生产）之前开始的。也就是说，这些库的设计是为了进行批量预测。它们处理1000个样本的速度比处理1个样本1000次的速度快。这主要是因为它们依赖于<a href="https://www.wikiwand.com/en/SIMD" target="_blank" rel="noopener noreferrer">SIMD<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>操作和线性代数技巧，在大量数据的情况下可以很好地扩展。因此，这些库不是进行个体预测的最佳选择。然而，可以在这些库的基础上使用小技巧降低预测的延迟。</p> <p>本文将重点讨论scikit-learn的一些优化技巧。首先，如果你打算在生产中使用或已经在使用scikit-learn，那么<a href="https://scikit-learn.org/stable/modules/computing.html" target="_blank" rel="noopener noreferrer">Computing with scikit-learn<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>文档是必读的。它包括了很多让计算变得更快的技巧和窍门。我将专注于预测速度，在机器学习的生产场景下，我们通常称之为为“延迟”。</p> <h2 id="操作示例"><a href="#操作示例" class="header-anchor">#</a> 操作示例</h2> <p>首先，让我们先测算scikit-learn的<code>LinearRegression</code>在单行上的预测速度。我将使用IPython的<code>%timeit</code>命令来得到一个可靠的估计。我还将使用scikit-learn的最新版本，到目前为止是<code>1.1.2</code>。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> sklearn <span class="token keyword">import</span> datasets
<span class="token keyword">from</span> sklearn <span class="token keyword">import</span> linear_model

X<span class="token punctuation">,</span> y <span class="token operator">=</span> datasets<span class="token punctuation">.</span>load_boston<span class="token punctuation">(</span>return_X_y<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
lin_reg <span class="token operator">=</span> linear_model<span class="token punctuation">.</span>LinearRegression<span class="token punctuation">(</span><span class="token punctuation">)</span>
lin_reg<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>X<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
<span class="token operator">%</span>timeit lin_reg<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>X<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token number">16</span> µs ± <span class="token number">119</span> ns per loop <span class="token punctuation">(</span>mean ± std. dev. of <span class="token number">7</span> runs, <span class="token number">100,000</span> loops each<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>16微秒的时间看起来并不多，但事实证明，我们可以做得更好。问题是，每次你调用<code>predict</code>时，scikit-learn都会进行大量的检查。例如，它检查你是否提供了一个二维的numpy数组，特征的数量是否正确，是否有任何值丢失，等等。在许多情况下，这些检查可能是多余的，因为你可能已经在你的应用程序中作为验证步骤的一部分自己做了这些检查。因此，我们可以写一个“裸化”的实现，跳过这些细节，直奔本质，也就是评估线性回归。从本质上讲，线性回归只是一个截距和一些权重与输入特征之间的点乘之和。我们可以自己实现这一点。为此，我们将定义一个带有<code>predict_single</code>方法的<code>BarebonesLinearRegression</code>类，该方法接收一个一维数组作为输入。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np

<span class="token keyword">class</span> <span class="token class-name">BarebonesLinearRegression</span><span class="token punctuation">(</span>linear_model<span class="token punctuation">.</span>LinearRegression<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">predict_single</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> np<span class="token punctuation">.</span>dot<span class="token punctuation">(</span>self<span class="token punctuation">.</span>coef_<span class="token punctuation">,</span> x<span class="token punctuation">)</span> <span class="token operator">+</span> self<span class="token punctuation">.</span>intercept_
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>让我们看看自己实现的方法会有多大提升：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>bb_lin_reg <span class="token operator">=</span> BarebonesLinearRegression<span class="token punctuation">(</span><span class="token punctuation">)</span>
bb_lin_reg<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>X<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
<span class="token operator">%</span>timeit bb_lin_reg<span class="token punctuation">.</span>predict_single<span class="token punctuation">(</span>X<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">590</span> ns ± <span class="token number">30.9</span> ns per loop <span class="token punctuation">(</span>mean ± std. dev. of <span class="token number">7</span> runs, <span class="token number">1,000</span>,000 loops each<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>“裸化”的实现平均比scikit-learn的实现快27倍。这个倍数在使用复杂度更高的模型时会显得更加明显。此外，除了考虑模型的预测时间还要考虑特征工程和来自HTTP协议的API的时间延迟，综合来看的话，模型部分的预测优化也更加有必要。</p> <p>我们可以将这个技巧应用于其他模型，比如scikit-learn的<code>LogisticRegression</code>。让我们首先评估一下默认的实现。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> sklearn <span class="token keyword">import</span> datasets
<span class="token keyword">from</span> sklearn <span class="token keyword">import</span> preprocessing

X<span class="token punctuation">,</span> y <span class="token operator">=</span> datasets<span class="token punctuation">.</span>load_digits<span class="token punctuation">(</span>return_X_y<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
X <span class="token operator">=</span> preprocessing<span class="token punctuation">.</span>scale<span class="token punctuation">(</span>X<span class="token punctuation">)</span>
log_reg <span class="token operator">=</span> linear_model<span class="token punctuation">.</span>LogisticRegression<span class="token punctuation">(</span><span class="token punctuation">)</span>
log_reg<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>X<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
<span class="token operator">%</span>timeit log_reg<span class="token punctuation">.</span>predict_proba<span class="token punctuation">(</span>X<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">26.5</span> µs ± <span class="token number">1.28</span> µs per loop <span class="token punctuation">(</span>mean ± std. dev. of <span class="token number">7</span> runs, <span class="token number">10,000</span> loops each<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>我们可以用scipy的softmax函数实现<code>predict_single</code>方法：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> scipy <span class="token keyword">import</span> special

<span class="token keyword">class</span> <span class="token class-name">BarebonesLogisticRegression</span><span class="token punctuation">(</span>linear_model<span class="token punctuation">.</span>LogisticRegression<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">predict_proba_single</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> special<span class="token punctuation">.</span>softmax<span class="token punctuation">(</span>np<span class="token punctuation">.</span>dot<span class="token punctuation">(</span>self<span class="token punctuation">.</span>coef_<span class="token punctuation">,</span> x<span class="token punctuation">)</span> <span class="token operator">+</span> self<span class="token punctuation">.</span>intercept_<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>让我们看看我们是否有什么收获：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>bb_log_reg <span class="token operator">=</span> BarebonesLogisticRegression<span class="token punctuation">(</span><span class="token punctuation">)</span>
bb_log_reg<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>X<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
<span class="token operator">%</span>timeit bb_log_reg<span class="token punctuation">.</span>predict_proba_single<span class="token punctuation">(</span>X<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">11.9</span> µs ± <span class="token number">57.2</span> ns per loop <span class="token punctuation">(</span>mean ± std. dev. of <span class="token number">7</span> runs, <span class="token number">100,000</span> loops each<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>这是一个肉眼可见的进步，但还可以继续优化。首先，我们可以用IPython的<code>%prun</code>命令来检查什么东西花的时间最多：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token operator">%</span>prun <span class="token operator">-</span>l <span class="token number">10</span> <span class="token punctuation">[</span>bb_log_reg<span class="token punctuation">.</span>predict_proba_single<span class="token punctuation">(</span>X<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">100000</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code> 
         <span class="token number">4200004</span> <span class="token keyword">function</span> calls <span class="token keyword">in</span> <span class="token number">1.761</span> seconds

   Ordered by: internal <span class="token function">time</span>
   List reduced from <span class="token number">32</span> to <span class="token number">10</span> due to restriction <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span>

   ncalls  tottime  percall  cumtime  percall filename:lineno<span class="token punctuation">(</span>function<span class="token punctuation">)</span>
   <span class="token number">100000</span>    <span class="token number">0.453</span>    <span class="token number">0.000</span>    <span class="token number">1.434</span>    <span class="token number">0.000</span> _logsumexp.py:7<span class="token punctuation">(</span>logsumexp<span class="token punctuation">)</span>
   <span class="token number">200000</span>    <span class="token number">0.195</span>    <span class="token number">0.000</span>    <span class="token number">0.195</span>    <span class="token number">0.000</span> <span class="token punctuation">{</span>method <span class="token string">'reduce'</span> of <span class="token string">'numpy.ufunc'</span> objects<span class="token punctuation">}</span>
   <span class="token number">300000</span>    <span class="token number">0.139</span>    <span class="token number">0.000</span>    <span class="token number">0.556</span>    <span class="token number">0.000</span> <span class="token punctuation">{</span>built-in method numpy.core._multiarray_umath.implement_array_function<span class="token punctuation">}</span>
   <span class="token number">200000</span>    <span class="token number">0.124</span>    <span class="token number">0.000</span>    <span class="token number">0.258</span>    <span class="token number">0.000</span> _ufunc_config.py:32<span class="token punctuation">(</span>seterr<span class="token punctuation">)</span>
   <span class="token number">100000</span>    <span class="token number">0.099</span>    <span class="token number">0.000</span>    <span class="token number">1.533</span>    <span class="token number">0.000</span> _logsumexp.py:130<span class="token punctuation">(</span>softmax<span class="token punctuation">)</span>
   <span class="token number">100000</span>    <span class="token number">0.090</span>    <span class="token number">0.000</span>    <span class="token number">0.125</span>    <span class="token number">0.000</span> _util.py:247<span class="token punctuation">(</span>_asarray_validated<span class="token punctuation">)</span>
   <span class="token number">200000</span>    <span class="token number">0.088</span>    <span class="token number">0.000</span>    <span class="token number">0.334</span>    <span class="token number">0.000</span> fromnumeric.py:69<span class="token punctuation">(</span>_wrapreduction<span class="token punctuation">)</span>
   <span class="token number">200000</span>    <span class="token number">0.088</span>    <span class="token number">0.000</span>    <span class="token number">0.097</span>    <span class="token number">0.000</span> _ufunc_config.py:131<span class="token punctuation">(</span>geterr<span class="token punctuation">)</span>
   <span class="token number">100000</span>    <span class="token number">0.068</span>    <span class="token number">0.000</span>    <span class="token number">1.729</span>    <span class="token number">0.000</span> <span class="token number">3744590719</span>.py:5<span class="token punctuation">(</span>predict_proba_single<span class="token punctuation">)</span>
   <span class="token number">100000</span>    <span class="token number">0.042</span>    <span class="token number">0.000</span>    <span class="token number">0.191</span>    <span class="token number">0.000</span> fromnumeric.py:2123<span class="token punctuation">(</span>sum<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>从数据中可以看出时间花在了哪里：是被special.softmax调用的logsumexp函数。special.softmax的实现方式避免了潜在的数字下溢和溢出，如这里所解释的。然而，它似乎比自定义的实现方式要慢，而后者仍然稳定。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">custom_softmax</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>
    z <span class="token operator">=</span> x <span class="token operator">-</span> <span class="token builtin">max</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    numerator <span class="token operator">=</span> np<span class="token punctuation">.</span>exp<span class="token punctuation">(</span>z<span class="token punctuation">)</span>
    denominator <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>numerator<span class="token punctuation">)</span>
    <span class="token keyword">return</span> numerator <span class="token operator">/</span> denominator

<span class="token keyword">class</span> <span class="token class-name">BarebonesLogisticRegression</span><span class="token punctuation">(</span>linear_model<span class="token punctuation">.</span>LogisticRegression<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">predict_proba_single</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> custom_softmax<span class="token punctuation">(</span>np<span class="token punctuation">.</span>dot<span class="token punctuation">(</span>self<span class="token punctuation">.</span>coef_<span class="token punctuation">,</span> x<span class="token punctuation">)</span> <span class="token operator">+</span> self<span class="token punctuation">.</span>intercept_<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>优化后的表现为：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>bb_log_reg <span class="token operator">=</span> BarebonesLogisticRegression<span class="token punctuation">(</span><span class="token punctuation">)</span>
bb_log_reg<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>X<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
<span class="token operator">%</span>timeit bb_log_reg<span class="token punctuation">.</span>predict_proba_single<span class="token punctuation">(</span>X<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">5.06</span> µs ± <span class="token number">96.4</span> ns per loop <span class="token punctuation">(</span>mean ± std. dev. of <span class="token number">7</span> runs, <span class="token number">100,000</span> loops each<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>这比使用special.softmax快2.35倍，比scikit-learn的默认实现快5.24倍。还凑合!</p> <p>线性回归和逻辑回归可能是简单的方法，但是根据微软团队最近的一份调查报告，它们是scikit-learn中使用最多的两个类，所以它们值得关注。那么对于scikit-learn的<code>StandardScaler</code>呢？它是任何线性模型之前的一个常见的特征预处理步骤，因此很可能会与上述两个模型一起使用。像前文一样，让我们从测量默认实现的性能开始。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> sklearn <span class="token keyword">import</span> preprocessing

scaler <span class="token operator">=</span> preprocessing<span class="token punctuation">.</span>StandardScaler<span class="token punctuation">(</span><span class="token punctuation">)</span>
scaler<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>X<span class="token punctuation">)</span>
<span class="token operator">%</span>timeit scaler<span class="token punctuation">.</span>transform<span class="token punctuation">(</span>X<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">16.9</span> µs ± <span class="token number">368</span> ns per loop <span class="token punctuation">(</span>mean ± std. dev. of <span class="token number">7</span> runs, <span class="token number">100,000</span> loops each<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>一个标准的缩放步骤只需要减去数据的列平均值并除以列标准差，就像这样：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">BarebonesStandardScaler</span><span class="token punctuation">(</span>preprocessing<span class="token punctuation">.</span>StandardScaler<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">transform_single</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>x <span class="token operator">-</span> self<span class="token punctuation">.</span>mean_<span class="token punctuation">)</span> <span class="token operator">/</span> self<span class="token punctuation">.</span>var_ <span class="token operator">**</span> <span class="token number">.5</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>这给我们带来了如下的表现：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1.23</span> µs ± <span class="token number">19.7</span> ns per loop <span class="token punctuation">(</span>mean ± std. dev. of <span class="token number">7</span> runs, <span class="token number">1,000</span>,000 loops each<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>现在，如果我们想把我们自定义的<code>BarebonesStandardScaler</code>与<code>BarebonesLinearRegression</code>或<code>BarebonesLogisticRegression</code>同时使用呢？在scikit-learn中，组成建模步骤的典型方法是通过使用管道。我们可以实现一个自定义的管道类，它继承自scikit-learn的<code>pipeline.Pipeline</code>，并提供一个<code>predict_single</code>函数和一个<code>predict_proba_single</code>函数。具体如下：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> sklearn <span class="token keyword">import</span> pipeline

<span class="token keyword">class</span> <span class="token class-name">BarebonesPipeline</span><span class="token punctuation">(</span>pipeline<span class="token punctuation">.</span>Pipeline<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">predict_single</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> _<span class="token punctuation">,</span> transformer <span class="token keyword">in</span> self<span class="token punctuation">.</span>steps<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            x <span class="token operator">=</span> transformer<span class="token punctuation">.</span>transform_single<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>steps<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>predict_single<span class="token punctuation">(</span>x<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">predict_proba_single</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> _<span class="token punctuation">,</span> transformer <span class="token keyword">in</span> self<span class="token punctuation">.</span>steps<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            x <span class="token operator">=</span> transformer<span class="token punctuation">.</span>transform_single<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>steps<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>predict_proba_single<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>让我们看看我们获得的执行速度如何：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>bb_pp <span class="token operator">=</span> BarebonesPipeline<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'bb_scaler'</span><span class="token punctuation">,</span> bb_scaler<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'bb_lin_reg'</span><span class="token punctuation">,</span> bb_lin_reg<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
bb_pp<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>X<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
<span class="token operator">%</span>timeit bb_pp<span class="token punctuation">.</span>predict_single<span class="token punctuation">(</span>X<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1.98</span> µs ± <span class="token number">48</span> ns per loop <span class="token punctuation">(</span>mean ± std. dev. of <span class="token number">7</span> runs, <span class="token number">100,000</span> loops each<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>现在让我们把它与scikit-learn的默认实现进行比较：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>pp <span class="token operator">=</span> pipeline<span class="token punctuation">.</span>Pipeline<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'scaler'</span><span class="token punctuation">,</span> scaler<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'lin_reg'</span><span class="token punctuation">,</span> lin_reg<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
pp<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>X<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
<span class="token operator">%</span>timeit pp<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>X<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">34.3</span> µs ± <span class="token number">1.81</span> µs per loop <span class="token punctuation">(</span>mean ± std. dev. of <span class="token number">7</span> runs, <span class="token number">10,000</span> loops each<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>我们的自定义实现大约快17.3倍。最后，我们可以检查我们的实现是否产生了正确的输出。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">for</span> xi <span class="token keyword">in</span> X<span class="token punctuation">:</span>
    <span class="token keyword">assert</span> pp<span class="token punctuation">.</span>predict<span class="token punctuation">(</span><span class="token punctuation">[</span>xi<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> bb_pp<span class="token punctuation">.</span>predict_single<span class="token punctuation">(</span>xi<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>我们的收获是，你可以用scikit-learn加快预测的速度，但这需要了解算法的实际工作原理和实现方式，这未必是一件坏事。</p></div></section> <footer class="page-edit"><!----> <!----></footer> <!----> <div class="comments-wrapper"><!----></div> <ul class="side-bar sub-sidebar-wrapper" style="width:12rem;" data-v-ac050c62><li class="level-2" data-v-ac050c62><a href="/blogs/online_learning/2022/091001.html#概述" class="sidebar-link reco-side-概述" data-v-ac050c62>概述</a></li><li class="level-2" data-v-ac050c62><a href="/blogs/online_learning/2022/091001.html#操作示例" class="sidebar-link reco-side-操作示例" data-v-ac050c62>操作示例</a></li><li class="level-2" data-v-ac050c62><a href="/blogs/online_learning/2022/091001.html#总结" class="sidebar-link reco-side-总结" data-v-ac050c62>总结</a></li></ul></main></div> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/assets/js/app.5f51664a.js" defer></script><script src="/assets/js/3.95a7dbf5.js" defer></script><script src="/assets/js/1.f34e988a.js" defer></script><script src="/assets/js/14.e8bd3478.js" defer></script>
  </body>
</html>
